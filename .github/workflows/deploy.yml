name: Deploy
on:
  push:
    branches: [ "main" ]

env:
  AWS_REGION: ap-northeast-2
  IMAGE: ghcr.io/rlagycks/moau_be:latest

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - name: 'Debug: OIDC 토큰 검증'
        uses: actions/github-script@v7
        with:
          script: |
            try {
              const token = await core.getIDToken('sts.amazonaws.com');
              core.info(' OIDC 토큰 성공적으로 가져옴');
              const payload = token.split('.')[1];
              const decodedPayload = Buffer.from(payload, 'base64').toString('utf-8');
              const payloadJson = JSON.parse(decodedPayload);
              core.info(`sub: ${payloadJson.sub}`);
              core.info(`aud: ${payloadJson.aud}`);
              core.info(`iss: ${payloadJson.iss}`);
            } catch (error) {
              core.setFailed(` OIDC 토큰 가져오기 실패: ${error.message}`);
            }

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::788391084087:role/moau-deploy-gha-role
          aws-region: ${{ env.AWS_REGION }}

      - name: Verify AWS Credentials
        run: |
          echo "=== AWS 자격증명 확인 ==="
          if aws sts get-caller-identity > /tmp/creds.json 2>&1; then
            echo " 자격증명 성공"
            cat /tmp/creds.json
          else
            echo " 자격증명 실패"
            cat /tmp/creds.json
            exit 1
          fi

      - name: Find target EC2 by tag Name=moau-ec2
        id: ec2
        run: |
          echo "EC2 인스턴스 검색 중..."
          if ID=$(aws ec2 describe-instances \
            --filters "Name=tag:Name,Values=moau-ec2" "Name=instance-state-name,Values=running" \
            --query "Reservations[0].Instances[0].InstanceId" --output text 2>&1); then
            if [ "$ID" = "None" ] || [ -z "$ID" ]; then
              echo " 실행 중인 moau-ec2 인스턴스를 찾을 수 없음"
              echo "모든 인스턴스 목록:"
              aws ec2 describe-instances --query 'Reservations[*].Instances[*].[InstanceId,Tags[?Key==`Name`].Value|[0],State.Name]' --output table
              exit 1
            fi
            echo " EC2 ID 찾음: $ID"
            echo "id=$ID" >> $GITHUB_OUTPUT
          else
            echo " EC2 describe-instances 실패"
            echo "$ID"
            exit 1
          fi

      - name: Deploy via SSM Run Command
        run: |
          echo "SSM 명령 전송 중..."
          if COMMAND_ID=$(aws ssm send-command \
            --instance-ids "${{ steps.ec2.outputs.id }}" \
            --document-name "AWS-RunShellScript" \
            --comment "MOAU deploy" \
            --parameters commands='[
              "set -e",
              "sudo mkdir -p /srv/moau && sudo chown $USER:$USER /srv/moau",
              "cd /srv/moau",

              "# --- .env 생성(Secrets → 런타임 주입) ---",
              "cat > .env <<\"ENV\"",
              "SPRING_PROFILES_ACTIVE=prod",
              "RDS_ENDPOINT=${{ secrets.RDS_ENDPOINT }}",
              "RDS_DB=${{ secrets.RDS_DB }}",
              "RDS_USER=${{ secrets.RDS_USER }}",
              "RDS_PASS=${{ secrets.RDS_PASS }}",
              "AWS_REGION=${{ secrets.AWS_REGION }}",
              "AWS_S3_BUCKET=${{ secrets.AWS_S3_BUCKET }}",
              "JWT_SECRET=${{ secrets.JWT_SECRET }}",
              "KAKAO_REST_API_KEY=${{ secrets.KAKAO_REST_API_KEY }}",
              "KAKAO_TOKEN_URI=https://kauth.kakao.com/oauth/token",
              "KAKAO_USER_ME_URI=https://kapi.kakao.com/v2/user/me",
              "KAKAO_REDIRECT_URIS=kakao9ec4a4d46982a8f4d7b19fcc7099c63c://oauth",
              "ENV",

              "# --- compose 파일(최초 1회 생성) ---",
              "if [ ! -f docker-compose.yml ]; then cat > docker-compose.yml <<\"YAML\"",
              "version: \"3.8\"",
              "services:",
              "  app:",
              "    image: ${IMAGE}",
              "    container_name: moau-app",
              "    restart: unless-stopped",
              "    ports: [\"80:8080\"]",
              "    env_file: [.env]",
              "    healthcheck:",
              "      test: [\"CMD\", \"wget\", \"-qO-\", \"http://localhost:8080/actuator/health\"]",
              "      interval: 20s",
              "      timeout: 5s",
              "      retries: 10",
              "YAML",
              "fi",

              "# --- GHCR 로그인 & 배포 ---",
              "echo \"${{ secrets.GITHUB_TOKEN }}\" | docker login ghcr.io -u ${{ github.actor }} --password-stdin",
              "docker compose pull",
              "docker compose up -d",
              "docker image prune -f"
            ]' \
            --output text 2>&1); then
            echo " SSM 명령 전송 성공"
            echo "Command ID: $COMMAND_ID"
          else
            echo " SSM 명령 전송 실패"
            echo "$COMMAND_ID"
            exit 1
          fi
